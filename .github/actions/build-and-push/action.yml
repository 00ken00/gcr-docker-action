name: 'Build and push to GCR'
description: 'Build and push to GCR'

inputs:
  # Ref: https://github.com/RafikFarhad/push-to-gcr-github-action/blob/master/action.yaml
  gcloud_service_key:
    description: Google cloud service key json file as plain text or base64 encrypted
    required: true
  registry:
    description: The registry where the image should be pushed
    required: true
  project_id:
    description: The project id
    required: true
  image_name:
    description: The image name
    required: true
  dockerfile:
    description: Dockerfile that will build the image
    required: false
    default: ""
  context:
    description: Docker build context
    required: false
    default: '.'

runs:
  using: "composite"
  steps:
    - name: replace slash to dash in github.ref_name
      uses: mad9000/actions-find-and-replace-string@1
      id: tag_name
      with:
        source: ${{ github.ref_name }}
        find: '/'
        replace: '-'
    - name: Build and push Docker image with auto tagging
      uses: RafikFarhad/push-to-gcr-github-action@v4.1
      with:
        gcloud_service_key: ${{ inputs.gcloud_service_key }}
        registry: ${{ inputs.registry }}
        project_id: ${{ inputs.project_id }}
        image_name: ${{ inputs.image_name }}
        image_tag: latest,${{ steps.tag_name.outputs.result }}
        dockerfile: ${{ inputs.dockerfile }}
        context: ${{ inputs.context }}
