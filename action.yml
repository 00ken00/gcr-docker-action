name: 'Build and push to GCR'
description: 'Build and push to GCR'

inputs:
  gcloud_service_key:
    description: json
    required: true
  registry:
    description: The registry where the image should be pushed
    required: true
  project_id:
    description: The project id
    required: true
  image_name:
    description: The image name
    required: true
  dockerfile:
    description: Dockerfile that will build the image
    required: false
    default: ""
  context:
    description: Docker build context
    required: false
    default: '.'

runs:
  using: "composite"
  steps:
    - id: 'auth'
      uses: 'google-github-actions/auth@v0'
      with:
        credentials_json: '${{ inputs.gcloud_service_key }}'

    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v0'

    - name: Configure docker
      shell: bash
      run: gcloud auth configure-docker --quiet

    - id: commit
      name: Output commit hash
      uses: pr-mpt/actions-commit-hash@v1

    - id: tag_name
      name: Replace slash to dash
      uses: mad9000/actions-find-and-replace-string@1
      with:
        source: ${{ format('{0}-{1}', github.ref_name, steps.commit.outputs.short) }}
        find: '/'
        replace: '-'

    - name: Build a docker image
      shell: bash
      run: docker build -t ${{ inputs.registry }}/${{ inputs.project_id }}/${{ inputs.image_name }}:latest,${{ inputs.tag }} ${{ inputs.context }}

#    - name: Push the docker image
#      shell: bash
#      run: docker push asia.gcr.io/${{ inputs.project_id }}/sueken:${GITHUB_SHA::7}

#    - name: Build and push Docker image with auto tagging
#      uses: RafikFarhad/push-to-gcr-github-action@v4.1
#      with:
#        gcloud_service_key: ${{ inputs.gcloud_service_key }}
#        registry: ${{ inputs.registry }}
#        project_id: ${{ inputs.project_id }}
#        image_name: ${{ inputs.image_name }}
#        image_tag: latest,${{ steps.tag_name.outputs.value }}
#        dockerfile: ${{ inputs.dockerfile }}
#        context: ${{ inputs.context }}
#